<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Diamond I21 Instructions</title>
    <meta name="date" content="2024-02-06">
    <link rel="stylesheet" href="markdown_to_html.css">
    <link rel="stylesheet" href="../assets/css/markdown_to_html.css">

</head>
<body>
    <div class="content">
        <h2 id="table-of-contents">Table of contents</h2>
<ol>
<li><a href="#1-mounting-samples">Mounting samples</a></li>
<li><a href="#2-loading-samples-in-load-lock">Loading samples in load lock</a></li>
<li><a href="#3-sample-transfer">Sample transfer</a></li>
<li><a href="#4-alignment-of-sample">Alignment of sample</a></li>
<li><a href="#5-xas-instructions">XAS instructions</a>
5.5 <a href="#5.5-rixs-instruction">RIXS instructions</a></li>
<li><a href="#6-problem-shooting">Problem shooting</a></li>
<li><a href="#7-checklist">Checklist</a></li>
<li><a href="#8-basic-commands">Basic Commands</a></li>
<li><a href="#9-other-useful-information">Other useful information</a></li>
<li><a href="#10-rough-steps-of-rixs-experiment">Rough steps of RIXS experiment</a></li>
<li><a href="#11-dawn-software">DAWN software</a></li>
<li><a href="#12-scripts">Read .nxs file</a></li>
</ol>
<h2 id="1-mounting-samples">1. Mounting samples</h2>
<ol>
<li>put silver paint on the holder before placeing samples on. samples are not expected to be too close to the edge of the holder.</li>
<li>parallel to the samples, there should also be carbon tape</li>
<li>paste the silver conductive paint on the edge of the sample all the way to the holder, to ensure a good conduction between the holder and the surface of the sample. This step is necessary for XAS. </li>
<li>Take a snapshot after mounting all samples on the holder. Mark the sample on the image. </li>
<li>the holder is good to go into the load lock.
<img src="/assets/figure_research/diamond_2024_02_sample_holder.jpg" style="max-width: 30em;"></li>
</ol>
<h2 id="2-loading-samples-in-load-lock">2. Loading samples in load lock</h2>
<p><strong>Vacuum chamber</strong>: There's a big vacuum chamber that the sample is supposed to go in. But it's hard to pump out the air entirely from this chamber, so this chamber should always be kept in vacuum. In order to load the sample into this big chamber without destorying the vacuum, there's a small chamber (called load lock) outside of the big chamber. Air is much easier to get pumped out from this small chamber. The key idea is to first load the sample into the load lock, pump out the air from the load lock, and when the vacuumness reaches the same as that in the big chamber, we transfer the sample to the big chamber.</p>
<p>On the screen: green = open; orange = closed. When we need to open a valve, we need to press <code>reset</code> then <code>open</code>.</p>
<ol>
<li>Close the two upper turbo pump from left to right on the top to stop the pump.</li>
<li>Open nitrogen gas valve. Slowly turn on the switch on the side clockwisely. Leave it open for a few seconds.</li>
<li>Open load lock, put sample holder in, close the lid. No need to screw up the lid.</li>
<li>Close the nitrogen gas valve, turn the switch off on the side again conter-clockwisely.</li>
<li>Open the rough pump by clicking the bottom right valve.</li>
<li>When the pressure reach $10^{-3}$, close the valve.</li>
<li>Open the two upper turbo pumps from right to left.</li>
</ol>
<p><img src="/assets/figure_research/diamond_vacuum_pump.jpg" style="max-width:30em"></p>
<h2 id="3-sample-transfer">3. Sample transfer</h2>
<p><strong>Taking out sample holder from the main chamber</strong>
- To do this, we need to first block the beam from getting into the sample chamber, as well as prevent the light from going into the CCD decetor. Therefore, we turn of the gates on both sides of the sample</p>
<p><img src="/assets/figure_research/diamond_sample_transfer_1.jpg" style="max-width:30em">
- Open the valve between main chamber (sample vessel) and the load lock, so that sample can be take out and transfered to the load lock. When the pipe shown on the screen become green, it means it's already open.</p>
<p><img src="/assets/figure_research/diamond_sample_transfer_5.jpg" style="max-width:30em">
- take out the window cover on the main chamber. Only take out the cover marked "✔️" , don't touch the middle cover. See the figure below. Then turn on the light by typing the command <code>lightOn</code>. After this we will be able to see the light through the window of the main chamber. </p>
<p><img src="/assets/figure_research/diamond_sample_transfer_2.jpg" style="max-width:30em">
- Move sample holder to the correct coordinate for the grabber to grab. It's written on the monitor near the machine: x=-1.73; y=0; z=-3.6 to 4.0; th=-54; chi=phi=0; 
- Look through the window, and you can see a "gate" covering the sample holder. Push in the "spear" near the window and tuck the tip of the spear into the hold on the top right corner of the gate. Slightly deflect the spear to the right to open the gate. Now you can see the edge of the sample hold from the right window.</p>
<p><img src="/assets/figure_research/diamond_sample_transfer_4.jpg" style="max-width:30em">
- Closed the pin on the transfer arm by turning the end counterclockwisely. Clear out anything in the load lock to make way for the transfer arm. Keep the transfer arm closed while moving the grabber with or without sample holder!!
- Twist the black knob near the load loack to move the transfer arm all the way into the main chamber/sample vessel. 
- Open the grabber by turning the knob on the other end of the transfer arm clockwisely. Then the grabber should go straight to the sample holder, the metal plate of the grabber should be on the left of the sample holder to make the grabbing sucessful.
- After inserting, close the grabber again. Draw the transfer arm all the way back till the end.
- <strong>Close the valve/gate between the sample vessle and the load lock!!</strong></p>
<p><img src="/assets/figure_research/diamond_sample_transfer_32.jpg" style="max-width:30em">
- restore the sample bar into the load lock in the right position. Push the transfer arm again into the load lock, and carefully load the sample inside the bar. </p>
<p><img src="/assets/figure_research/diamond_sample_transfer_6.jpg" style="max-width:30em">
- Open the grabber and move the transfer arm back. </p>
<p><strong>Transfering sample from the load lock to the sample vessel/main chamber</strong>: The process is nothing but the reverse. 
- make sure the valve between the sample vessel and the load lock is closed, and the grabber is closed.
- push the transfer arm to the load lock, and grab the sample.
- open the valve, push the sample into the sample vessel, tuck it in the correct position.
- Move th to -80 so that we can close the gate
- close the gate near the sample holder again by deflecting the spear. You will feel a click when the gate is closed successfully.
- draw back the transfer arm, close the valve.</p>
<p><img src="/assets/figure_research/diamond_sample_transfer_3.jpg" style="max-width:30em"></p>
<h3 id="intermediate-step-find-and-locate-samples">Intermediate step: find and locate samples</h3>
<p>We need to locate our sample and carbon tape first.
- Open camera: - move theta to 140, and (hitchhiker page 3) window &gt; EPICStream &gt; Sample Camera 3</p>
<blockquote>
<p>Sample position are stored in a dictionary called <code>sample_pos</code>. Multiple sample positions can be stored in this dictionary with differeny key names. </p>
<p>Cabon tape positions are stored in another dictionary <code>carbon_tape_pos</code>. </p>
</blockquote>
<ul>
<li>move the cross to the carbon tape by doing <code>inc z 0.1</code> or <code>pos z &lt;position&gt;</code></li>
<li>Once we reach the correct position, we store it in a dictionary <code>save_sample_positions("&lt;name&gt;")</code>. To move the motor to the sample later, we can call <code>move_to_sample_positions("&lt;name&gt;")</code>. </li>
<li>For carbon tape, everything is the same, apart from the name of the function: <code>save_carbon_tape_positions("&lt;name&gt;")</code>, and <code>move_to_carbon_tape_positions("&lt;name&gt;")</code></li>
<li>to delete a specific position: <code>del sample pos["&lt;name&gt;"]</code>, or <code>del carbon_tape_pos["&lt;name&gt;"]</code></li>
</ul>
<h2 id="4-alignment-of-sample">4. Alignment of sample</h2>
<p><strong>Sample rough alignment</strong>: Use the camera to locate samples and find the boundaries and the centers of the samples.
- Move camera to correct position: <code>pos th 140</code>.
- Turn on camera: <code>window &gt; MJPEG streams &gt; Sample Camera 3</code>, and turn the light on <code>lightOn</code>
- find the position of samples by moving y and z <code>pos x &lt;value&gt;</code> and <code>pos z &lt;value&gt;</code>
- Turn the light off afterwards <code>lightOff</code></p>
<p><strong>Coarse XAS</strong>: We need to determine which detector to use. The current (photoelectric current) or the diode (fluorescence).
- check whether the vessel valves is opened, i.e. if the beam is going through the sample vessel. We can see this from the control panel, at the bottom where the beam and all the optical elements are shown. If not, go to GDA panel -&gt; "live controls 2", press "open vessel valve".
- <code>pos m5tth &lt;armtth&gt;</code>: move the collection mirror close to the angle of the arm, usually 150. (<em>why</em>) 
- <code>pos difftth &lt;armtth+1.5&gt;</code>: this is the tth of the diode, 1.5 degree above the collection mirror <code>m5tth</code> to move the diode to the position of the spectrometer arm. 
- <code>pos th 90</code>: normal incident to increase the signal.
- change the fast shutter on the control panel to <code>source: FSXAS</code>. Or <code>fsxas()</code>
- (optional) <code>gv17('Close')</code> 
- <code>pos eslit 50 microns</code>: change slit to 50 to increase the flux
- <code>repeat_xas(550, 600, 1)</code>: from 550 to 600 eV,  1 repeatition, in the step of 0.05 eV (unchangable). This is the <em>on-the-fly</em> XAS scan. This will automatically set the fast shutter mode to <code>fsxas()</code>. 
- We can also do a <em>step-scanning</em> XAS by calling: <code>scan energy 550 600 0.25 diff1  draincurrent fy2 m4c1 checkbeam</code>. But beware that this will not automatically set the fast shutter mode to <code>fsxas()</code>.</p>
<blockquote>
<p>If diode signal or drain current is too low: we changed to low noise mode:
- <code>draincurrent_i.setGain(1e8)</code>
- <code>diff1_i.setGain(1e9)</code>
- <code>fy2_i.setGain(1e9)</code></p>
<p>If it's saturated, we lower the gain, for example to 1e7 for draincurrent.</p>
</blockquote>
<p>Also if the signal (draincurrent) is still weird, we can try to move the position a bit closer to the silver paint, to increase conduction  </p>
<p><strong>Looking for good spot on sample</strong>: (especiallt important for cleaved samples or small sample, but this is not super necessary for big thin film as it has good surface) . Still at <code>th=90</code>
- set energy to resonance: <code>pos energy &lt;on resonance&gt;</code>, <code>pos th 90</code>
- set detector to ERIO or FSXAS on the control panel.
- do XAS: <code>rscan z -0.5 0.5 0.05 drain_i 1 diff1_i 1</code>
- set energy to off-resonance: <code>pos energy &lt;off resonance&gt;</code>
- do XAS: <code>rscan z -0.5 0.5 0.05 drain_i 1 diff1_i 1</code>
- place z at best position: <code>pos z &lt;best z&gt;</code></p>
<p>do the same for y coordinate. record the best positions of all samples on the logbook.</p>
<p><strong>Half cutting</strong>: The purpose of half cutting is to ensure the signal is sitting in the middle of the CCD. In this step we don't need to go to resonance.
- set detector/source as ERIO or FSXAS. But if we use ERIO, we need to close the gate right after the sample (the first gate bewteen the sample and the CCD) on the control panel.
- position the beam roughly parallel to the sample surface: <code>pos th 0</code>
- move diode detector in the opposite side of the incoming beam: <code>pos difftth 0</code>
- enlarge gap: <code>pos eslit 50</code>
- move (y,z) to the sample
- change gain: <code>diff1_i.setGain(1e5)</code>
- relative scan x: <code>rscan x -0.2 0.2 0.02 diff1</code>
- look for the maximum of the 1st derivative: <code>pos x &lt;best x&gt;</code>
- scan th: <code>rscan th -3 3 0.2 diff1</code>
- loof for the peak of the signal: <code>pos th &lt;best th&gt;</code>
- repeat the x/th scan until it converges.</p>
<p><img src="/assets/figure_research/half_cutting_x.jpg" style="max-width:24em">
<img src="/assets/figure_research/half_cutting_th.jpg" style="max-width:22em"></p>
<p>Once we have them optimized, we would have the preliminary <code>x</code> value, and <code>th</code> offset. Take note of the <code>x</code> and <code>th</code> offset. </p>
<p>The next step is to do the same for carbon tape. But for carbon tape, we only need the <code>x</code>, but <code>th</code> is not needed. Because carbon tape always have good signal at any <code>th</code>. </p>
<p>Remember to change parameters back afterwards: 
- <code>pos eslit 20</code>: change back the slit.
- turn the fast shutter back to <code>primary</code> on the control panel.
- <code>pos difftth 0</code>. 
- <code>pos energy &lt;resonance energy&gt;</code>. </p>
<p>If the signal is still not centered on the CCD, we could still do <code>inc x -0.1</code> to get it centered. Positive value 👈, negative value 👉. The more grazing it goes, the more senstive it is.</p>
<p><strong>Test RIXS</strong>
- <code>primary()</code>: change the mode of the fast shutter to camera mode
- <code>pos th &lt;any value&gt; difftth 0</code>: diode to zero to avoid blocking.
- <code>pos m5tth 150</code>: make sure the collecting mirror <code>m5</code> is at the same angle as the spectrometer arm.
- <code>pos energy &lt;resonance&gt;</code>
- <code>gV17('Open')</code>
- <code>acquireRIXS 1 andor 60</code> or <code>get_rixs(1,20)</code>.</p>
<p><strong>Finer adjustment of x</strong>: 
- the rixs signal should be at the (horizontal) center of the CCD (which you can see on the GDA panel). If it's not, we can fine tune the <code>x</code> position to make it horizontally centered. 
- By doing <code>pos spech xx</code> we can move the RIXS signal on the CCD vertically.</p>
<p><strong>Finding specular;  Finer alignment in chi and phi</strong>: This time we will make use of the specular condition and perform rixs scan. The arm tth is set to 150 (nominal). The actual tth is 150+4 degree. Therefore the specular condition is th=154/2 = 77 degree. But this is just a rough estimation of specular condition, we can finely calibrate this specular th. <em>Remember, when you go to the sample in the beginning. Use <code>pos x 1 y 1 chi 1.5</code> insetad of <code>pos ps_chi 1.5</code> After this, in the scanning process we should use <code>ps_chi</code> rather than <code>chi</code></em>.</p>
<ul>
<li>set detector/source to primary on the control panel</li>
<li>place th to rough specular condition: <code>pos th 77+&lt;th_detune&gt;</code></li>
<li>create region to integrate the RIXS signal. This region should enclose the RIXS signal and make it as narrow as possible. This can be done on the "Data acquisition client - beamline I21" computer, in the region editor.</li>
<li>scan pseudo chi using andor (RIXS detector): <code>rscan ps_chi -1 1 0.1 andor 5</code></li>
<li><code>pos ps_chi &lt;best_chi&gt;</code></li>
<li>scan th using andor again to find the best theta: <code>rscan th -1.5 1.5 0.1 andor 5</code></li>
<li><code>pos th &lt;best th&gt;</code></li>
<li>redo the pseudo chi scan, until they converge.</li>
<li>note down the best <code>chi</code> and calculate the <code>th</code> offset. update the offset on your logbook. </li>
</ul>
<p>Since this time the sample is STO. It has a perfect crystal structure. The elastic peak is supposed to be really sharp. Therefore, the scan might need very fine steps to find the real specular condition.</p>
<p>After doing all this, note down the best <code>chi</code> and <code>th</code> as chi and theta offset. and narrow down the slit <code>pos eslit 20</code> (check). and remember to turn back the diode <code>difftth 0</code>, otherwise it will block the outgoing beam.</p>
<h2 id="5-xas-instructions">5. XAS instructions</h2>
<p>We need to determine which detector to use. The drain current (draincurrent<code>) or the diode (</code>diff1<code>). If the sample is super flurorecence, the diode/diff1 will not work properly. If the sample is too insulating, the draincurrent will not work properly, unless we put silver paint on the edge and the sample holder and move the beam close to the silver paint. But usually we acuire both data and see which one looks better...
-</code>pos difftth <armtth+1.5> th 90 m5tth <armtth><code>: position diode and the sample to the right place. m5 should be at the same angle as the arm, and the diode should be 1.5 degree above the arm.
- change the fast shutter on the control panel to</code>source: FSXAS<code>. Or simply type the command:</code>fsxas()<code>-</code>pos eslit 50<code>: open up the gap to 50, benefiting from higher flux.
- Scanning modes:
    1. on-the-fly XAS:</code>repeat_xas(550, 600, 1)<code>. This will automatically set the fast shutter mode to</code>fsxas()<code>.
    2. standard scan:</code>scan energy 528 533 0.1 diff1 draincurrent fy2<code>, energy from 528 to 533 in steps of 0.1 eV.
    3. standard scan with predefined scanning time: start scanning with integral mode:</code>scan energy 528 533 0.1 diff1_i 1 draincurrent_i 1 fy2_i 1<code>, with 1 second counting time
    4. Using Andor detector (standard RIXS detector):</code>scan energy 510 560 0.5 andor 20<code>, with counting time of 20 seconds. 
    5. relative scan:</code>rscan energy -13 17 0.25 diff1_i 1<code>. at the end of the scan, the motor will go back to where it started off. We can also set the number of points we want to collect, instead of the step size:</code>dscan energy 630 660 100 diff1_i 1`.</p>
<p>After XAS, remember to change the gap back to 20, move the diode back, and tune energy to resonance afterwards
- <code>pos eslit 20</code>
- turn the fast shutter back to <code>primary</code> on the control panel.
- <code>pos difftth 0</code>. 
- <code>pos energy &lt;resonance energy&gt;</code>. </p>
<h2 id="55-rixs-instruction">5.5 RIXS instruction</h2>
<p>For a normal long RIXS scan, usually we need to do: (1) dark image from the very beginning and only the very beginning; (2) carbon tape image before or after each long RIXS scan; (3) a long RIXS scan</p>
<p><strong>Dark image</strong>:
- <code>erio()</code>
- <code>fastshutter('Closed')</code>: block the incoming beam for the dark image
- <code>acquiredark 1 andor 180</code>: the counting time should be the same as the RIXS counting time of each frame.
- <code>fastshutter('Open')</code>: unblock the beam for further RIXS.</p>
<p><strong>Move to resonance</strong>:
- <code>pos energy &lt;resonance&gt;</code>
- <code>pos spech &lt;best_spech&gt;</code>: we need to determine the best <code>spech</code> at this energy. This control the position of the signal on the CCD. 
- if we are doing energy map, each energy corresponds to a different <code>spech</code> value. There is a pre-defined function to move to the correct <code>spech</code> value for each energy. Consult the local contact/beamline scientisit for this function.</p>
<p><strong>Carbon tape</strong>:
- move to carbon tape: <code>pos x &lt;x_carbon&gt; y &lt;y_carbon&gt; z &lt;z_carbon&gt;</code>
- <code>acquireRIXS 1 andor 180</code> <p style="color:red;"> check if it's andor or CCD</p></p>
<p><strong>Sample</strong>:
- move to the sample: <code>pos x &lt;x_sample&gt; y &lt;y_sample&gt; z &lt;z_sample&gt;</code>
- move theta: <code>pos th &lt;th + th_offset + th_detune&gt;</code>
- <code>acquireRIXS 1 andor 180</code></p>
<h2 id="6-problem-shooting">6. Problem shooting</h2>
<p><strong>Reset movement</strong>: When someone accidiently goes into the danger zone near the arm. The movement will be tripped. To restart the movement
- come back in the control room, press the blue button near the door "laser scanners tripped reset"
- On the bottom of the scrren, there is an illustration of the beamline. Near the end of the beamline there is an "arm".
- press "enable arm motion"
- "click the number in the box and press enter'</p>
<p>13 $\mu m$ each pixel</p>
<p><strong>Weak XAS drain current</strong>:
- check if the light is off.
- check if the vessel valve is open, otherwise there's no beam
- check if the <code>difftth=151.5</code> and <code>m5tth=150</code> and <code>th=90</code> is in correct position
- check if the draincurrent gain is high enough.
- check if there's silver paint on the sample. if there is, move the beam closer to the silver paint to increase conduction. </p>
<h2 id="7-the-logic-of-sample-movement">7. The logic of sample movement</h2>
<p><img src="/assets/figure_research/diamond_manipulator.jpg" style="max-width: 20em; ">
<img src="/assets/figure_research/esrf_manipulator.jpg" style="max-width: 24em;"></p>
<p><strong>ESRF</strong>: order of priority theta -&gt; chi -&gt; phi -&gt; x/y/z. The center of rotation is fixed and is independent of the x/y/z value. The beam goes through the center of rotation. Moving x/y/z doesn't change the center of rotation. Therefore, in ESRF we don't need pseudo chi <code>ps_chi</code>. The position of the beam is fixed at the center of rotation, while the center of rotation is independent of x/y/z. </p>
<p><strong>Diamond</strong>: order of priority x/y/z -&gt; theta -&gt; chi -&gt; pi. The center of rotation moves as x/y/z changes. The beam does not go through the center or rotation. Therefore, when moving chi and phi, the position of the beam on the sample will change. That's why they have pseudo_chi and pseudo phi rotation: this command <code>ps_chi</code> rotates the sample in chi while keeping the beam fixed at the sample point on the sample. </p>
<p>Therefore, when doing <code>pos chi 1</code>, only the value of chi will change keeping all the other coordinates unchanged. However, the point at which the beam is shining on the sample will change. This is the reason why we need to note down x/y/z/ and chi/phi at the same time. x/y/z alone doesn't determine where the beam is shining on the sample. For the same reason, if we want to go back to a particular position on the sample, we do <code>pos x 1 y 1 z 1 chi 1</code>, but not <code>ps_chi 1</code>. We have to specify the chi when we go to the sample.</p>
<p>On the other hand, <code>pos ps_chi 1</code> will indeed move chi to 1, but the x/y/z coordinate will also change because this pseudo chi ensures the beam to stay at the same position on the sample, which requires a movement in the translational coordinates.  When we do the chi scan, we need to use <code>ps_chi</code> to rotate the sample, because in this case we don't care about the exact x/y/z value, but rather we want to fix the beam at same position on the sample.</p>
<h2 id="8-basic-commands">8. Basic Commands</h2>
<h4 id="moving-motors">Moving motors</h4>
<p>Unit: micrometer mm
- absolute poisition: <code>pos x 2 y 3 z 2.5</code>. We can move x/y/z at the same time
- increase the position by a rlative amount: <code>inc x 0.2</code>
- move chi and phi while keeping x/y/z fixed: <code>pos chi 1</code>, <code>pos phi 2</code>. This movement keeps x/y/z fixed but the position at which the beam is shining on the sample will change due to the design of the motor.
- to ensure the position of the beam on the sample does not change, we need to use pseudo chi <code>pos ps_chi 1</code> and pseudo phi <code>pos ps_phi</code>. See section <a href="#the-logic-of-sample-movement">logic of sample movement</a> for more details.
- we don't need pseudo theta <code>pos th 90</code>.</p>
<h4 id="changing-energy-and-polarization">Changing energy and polarization</h4>
<ul>
<li>change incoming energy: <code>pos 531</code></li>
<li>Linear vertical polarization: <code>pos idscannable([31.0, 'LV', 28])</code>, <code>pos energy 529.5</code> (<p style="color:red;"> Check!</p>)</li>
<li>Linear horizational polarization: <code>pos idscannable([31.0, 'LH', 0])</code>, <code>pos energy 529.5</code></li>
<li><code>go(energy_val, LV)</code>. </li>
</ul>
<h4 id="changing-size-of-exit-slits">Changing size of exit slits</h4>
<p>Usually when doing XAS we open the gap up to 50, and close it down to 20 when doing RIXS.
- change the exit slits: <code>pos eslit 20</code>. Unit: micron.</p>
<h4 id="acquiring-images-with-andor-detector">Acquiring images with ANDOR detector</h4>
<ul>
<li>acquire 1 image, each with 60 seconds of exposure time: <code>acquireRIXS 1 andor 60</code></li>
<li>absolute scan: <ul>
<li>scan energy between 630 eV and 660 eV in steps of 250 meV using the photodiode (XAS): <code>scan energy 630 660 0.25 diff1</code></li>
<li>same scan, but using ANDOR detector, counting 20 seconds per point: <code>scan energy 630 660 0.25 andor 20</code></li>
<li>we could also measure diode signal and drain current at the same time: <code>scan energy 630 660 0.25 diff1 draincurrent</code></li>
</ul>
</li>
<li>relative scan: <ul>
<li>relative scan energy from -13 eV below to 17 eV above in steps of 0.25 eV: <code>rscan energy -13 17 0.25 andor 20</code></li>
<li>theta scan. th motor relative scan from -4 blow to 4 above, with tth motor running simultaneously from -8 below with the step of 0.4, double the step in the th motor: <code>rscan th -4 4 0.2 difftth -8 0.4 smpcdiff1 1</code></li>
<li>mesh scan of th and tth, just include the end point of tth: <code>rscan th -4 4 0.2 difftth -8 8 0.4 smpcdiff1 1</code>.</li>
</ul>
</li>
<li>scan with number of steps input<ul>
<li><code>dscan energy 630 660 100 andor 20</code></li>
</ul>
</li>
</ul>
<h4 id="shutter-mode">Shutter mode</h4>
<p>The shutter is located before the sample vessel. The shutter prevents the sample from being exposed to the beam too much. There are three modes:
- <code>primary()</code>: For RIXS. The shutter is syn with the CCD detector.
- <code>fsxas()</code>: For XAS.
- <code>erio()</code>:</p>
<h4 id="others">Others</h4>
<p>The checkbeam function will pasue the scan during the refills and if the beam is down. we need to add the function to the end of the scan: <code>scan energy 600 660 0.25 andor 20 checkbeam</code>.</p>
<p>the variable <code>m4c1</code> is the $I_{0}$, the current in the refocussing mirror 4 before the sample. To collect this just add one more command after the scan command: <code>rscan energy 600 650 0.25 diff1_i 1 m4c1 1</code>.</p>
<p>changing polarization: <code>go(531, LV)</code> for LV; LH; CR (circular right) and CL (circular left.)</p>
<h2 id="checklist">Checklist</h2>
<h4 id="xas-running-checklist">XAS running checklist</h4>
<ul>
<li><em>Inside the hall</em>: all the windows have been properly closed (3+2 windows).</li>
<li><code>difftth</code> (151.5) and <code>th</code> (usually 90) and <code>eslit</code> (usually 50), and <code>m5tth</code> (usually 150) are correct</li>
<li>faxas()</li>
<li>if fluorescence doesn't work, figure out why, could be the window problem.</li>
<li>check if the light is off.</li>
<li>check if the vessel valve is open, otherwise there's no beam</li>
<li>check if the draincurrent gain is high enough (1e7 or 1e8)</li>
<li>check if there's silver paint on the sample. if there is, move the beam closer to the silver paint to increase conduction. </li>
</ul>
<h4 id="rixs-running-checklist">RIXS running checklist</h4>
<ul>
<li>sample and carbon tape position</li>
<li>dark image and carbon tape in included in the macro</li>
<li>Sysyem parameters: slit(eslit ), spech, spechgamma, </li>
<li>exposure time for sample, dark image, and carbon tape should be the same</li>
<li>the test rixs signal is well centered on the CCD </li>
<li><em>Inside the hall</em>: the window lid is back on. Three horizontal lids and two lids atop; camera light is off. We can probably see the effect of "window not being closed" by florencense/XAS. In that case, draincurrent works but florencense doesn't work. </li>
</ul>
<h4 id="data-processing-checklist">data processing checklist</h4>
<ul>
<li>Two operations: dark image background subtraction + combined rixs process</li>
<li>dispersion/energy_per_pixel, slope override</li>
<li>check if dark image is properly subtracted, tweak "drop zone width factor" if necessary. usually the factor is around 5-15.</li>
<li>data is saved in a correct folder</li>
</ul>
<h4 id="other-problem-shooting">Other problem shooting</h4>
<ul>
<li>is the blue light triggered?</li>
<li>is the beam down?</li>
<li>is the SGM value becoming red and refuses to move? </li>
</ul>
<h2 id="9-other-useful-information">9. Other useful information</h2>
<p>The CCD is tilted to reduce the effective size of a pixel. We can change the effective size of the pixel to match the resolution of the beam. This time the angle of the CCD is 20 degree, which means it's 70 degree away from perpendicular position. </p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Value</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>resolution</td>
<td>4.4 pixel</td>
<td>#329931 - #329935</td>
</tr>
<tr>
<td>calibration</td>
<td>0.0060592 eV/pixel</td>
<td>#329930</td>
</tr>
<tr>
<td>slope</td>
<td>0.041512</td>
<td></td>
</tr>
<tr>
<td>resolution</td>
<td>26.66048 meV</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Dark image</strong>: we also need to take a dark image at least once everytime we change the "environment" of the sample and the CCD, for example <code>spech</code>, <code>tth</code>. This is for background subtraction. In the Dawn software, we need to input the file name of the dark image on the top right box for future background subtraction!</li>
<li><strong>Carbon tape is necessary</strong>: The resolution might be drifting during the acquisition. It is recommened to measure carbon tape everytime before we start a long scan. every 2 hours for example.</li>
<li><strong>Moving tth</strong>: each tth corresponds to some special parameters that optimize the resolution at each tth point. We might need to ask our local contact to optimize this for us and fit the parameters vs tth with a polynomial. everytime we move tth, there should be a series of parameters change followed. Better to wrap those changes in a function. </li>
<li><strong>Are we hitting any dirt on the sample?</strong>: usually it has a different x value, so the signal will be at a different horizontal position on the CCD. With this we can identify whether we are hitting the sample of something else. </li>
<li><strong>Coding macro</strong>: we can't put space in the expression in the macro!!!!!!! <code>a=b+2</code>✔️， but not <code>a=b + 2</code>❌!!!!!!!</li>
</ul>
<h2 id="10-rough-steps-of-rixs-experiment">10. Rough steps of RIXS experiment</h2>
<ul>
<li>mount samples</li>
<li>transfer samples to the load lock</li>
<li>(next day) Optimize beam system to get the best resolution. This is done by the local contact</li>
<li>aligning samples (finding samples and perform half cutting)</li>
<li>finer alignment of samples</li>
<li>XAS</li>
<li>test RIXS</li>
<li>dark image</li>
<li>carbon tape</li>
<li>energy scan</li>
</ul>
<p><em>Examplary code for a RIXS scan</em></p>
<pre class="codehilite"><code class="language-python">x_s = 1
y_s = 1
z_s = 1
# ...
th_val = 32 #degree
energy_val = 532 #eV



# define function to move to samples
def S_p():
    pos x x_s
    pos y y_s
    pos z z_s
    pos phi phi_s
    pos chi chi_s
def ctape_p():
    # move to carbon tape

# change polarization to LV. No `goLV(energy) anymore`
go(energy_val, LV)

# measure dark images before the E scan
pos energy 600
erio()
fastshutter('Closed')
acquiredark 1 anodr 180
primary()
fastshutter('Open')

# here we start the measurement
pos energy energy_val
spech_val = &lt;special function&gt; # ask the staff
pos spech = spech_val

# measure carbon tape
pos th 77
ctape_p()
print(&quot;carbon tape: th = %.3f and energy = %.3f&quot;, th_val, energy_val)
acquireRIXS 1 CCD 180 m4c1 180 checkbeam

# measure sample
pos th 36
th_offset = 1.6
th_detune = 3
pos th th_val + th_offset + th_detune
print(&quot;Sample: th = %.3f and energy = %.3f&quot;, th_val, energy_val)
acquireRIXS 40 CCD 180 k4c1 180 checkbeam

print(&quot;************************************************&quot;)
</code></pre>

<h2 id="11-dawn-software">11. DAWN software</h2>
<p><strong>Open DAWN</strong>: open terminal -&gt; <code>module load dawn/rixs</code> -&gt; <code>dawn</code></p>
<p><strong>Processing</strong>:
- open the correct folder in <code>/data/2024/&lt;beamtime-number&gt;/</code>
- <code>.nxs</code> data are the image-like CCD data. Drag the data into the top left "Data Slice view" window, and this data is ready for processing.
- For each <code>.nxs</code> RIXS data, we drag it to the "Data slice panel" to process them. 
- We need to process them properly in the processing window. This requires correct dispersion/energy per pixel, and slope, and dark image file. The processing operator include: (1) image background subtraction - fitted to PDF; and (2) combined RIXS image reduction. During this process, the background will be subtracted, using the dark image; and the CCD image will be summed over horizontally, with certain slope; the y axis of the CCD will be converted to energy loss according to the dispersion/energy per pixel.
<a href="/assets/figure_research/dawn_preprocessed.jpg"><img src="/assets/figure_research/dawn_preprocessed.jpg"> </a>
- What to check before processing the image:
    1. "Slope" and "energy resolution coefficient (eV/pix)" are correct. Usually these two parameters do not change over the beamtime
    2. Dark image reduction properly set. click "processing window" -&gt; click "image background subtraction - Fitted to a PDF". customize the right panel: (1) Dark image file; (2) check "remove outliers from dark image"; (3) "Gaussian smoothing length parameter" roughly 5; (4) "Drop zone with factor" roughly 2.5; Check the image reduction panel and make sure that the background looks like a background in the data.
    <a href="/assets/figure_research/dawn_preprocessed_2.jpg"><img src="/assets/figure_research/dawn_preprocessed_2.jpg"> </a>
    3. Click "Combined RIXS image reduction" -&gt; customize the right panel: (1) "slope override" and "energy calibration" should be correct; (2) "elastic line scan" should be set to "same scan"; (3) click "cutoff enable" to enable removing cosmic ray; (4) set "correlation energy range" to a certain range for the cross-correlation. Should be covering the elastic peak; (5) Set "zero energy offset" to MANUAL_OVERRIDE, and set "zero energy offset" to move the elastic peak to zero energy.
- after filling this information in, we click ▶️ in the "data slice view" panel, create a new folder in the <code>/processing</code> folder, name it as "processed" for example. Click on "link original data (no data copied)", and then click OK. We can go to <strong>DataVis</strong> window for data visualization.</p>
<p><strong>Visualization</strong>:
- On the left panel, open the folder of the processed data in the <code>/processing/processed/</code> folder.
- In the DataVis window, you might need to select and deselect the file on the left to refresh the possible labels on the right panel. On the top right you can choose to plot the "default" label (you will need this for XAS data), or processed results (for RIXS processed result). P.S. we don't need to process XAS data
- On the rightmost panel, click "default" and change it to "processed", click <code>correlated_spectrum_0</code> and we will see the spectrum.
<a href="/assets/figure_research/dawn_datavis.jpg"><img src="/assets/figure_research/dawn_datavis.jpg"> </a>
- to plot a 2d color map: we need to go to DataVis window -&gt; top left, XY Data, aggregate by labels -&gt; we need to save the image somewhere.  </p>
<h2 id="12-scripts">12. Scripts</h2>
<p><strong>From .nxs to .txt or .json</strong>:
- <p style="color:red;"> Used only in PYTHON!</p>. We can use the following pre-defined function to convert the <code>.nxs</code> file to <code>.txt</code> or <code>.json</code> file. This function will extract the energy loss and intensity data from the <code>.nxs</code> file and save it as a <code>.txt</code> (first column energy, second column intensity) or <code>.json</code> file (as dictionary).</p>
<pre class="codehilite"><code class="language-python">import h5py
import json


# Function to extract specific datasets and save as a txt file
def nxs2txt(file_to_read, file_to_write):
    &quot;&quot;&quot; transform `.nxs` file to `.txt` file. It can only process one single `.nxs` file at a time.

    Args:
    -----------------------
    - file_to_read (str): path to the input `.nxs` file
    - file_to_write (str): path to the input `.txt` file

    output:
    -----------------------
    - dict: dictionary containing the energy and intensity data

    Example:
    -----------------------
    &gt;&gt;&gt; data_dict = nxs2txt(&quot;path/to/input.nxs&quot;, &quot;path/to/output.txt&quot;)
    &quot;&quot;&quot;
    with h5py.File(file_to_read, &quot;r&quot;) as f:
        # Extract the specific datasets
        energy_loss = f[
            &quot;/processed/summary/1-Combined RIXS image reduction/normalized_correlated_spectrum_0/Energy loss&quot;
        ][:]
        data = f[
            &quot;/processed/summary/1-Combined RIXS image reduction/normalized_correlated_spectrum_0/data&quot;
        ][:]
    # Save it as a txt file
    with open(file_to_write, &quot;w&quot;) as f:
        f.write(&quot;Energy loss, Intensity\n&quot;)
        for i in range(len(energy_loss)):
            f.write(f&quot;{energy_loss[i]}, {data[i]}\n&quot;)

    return {&quot;energy&quot;: energy_loss, &quot;intensity&quot;: data}


# Function to extract specific datasets and save as a JSON file
def nxs2json(file_to_read, file_to_write):
    &quot;&quot;&quot; transform `.nxs` file to `.json` file. It can only process one single `.nxs` file at a time.

    Args:
    -----------------------
    - file_to_read (str): path to the input `.nxs` file
    - file_to_write (str): path to the input `.json` file

    output:
    -----------------------
    - dict: dictionary containing the energy and intensity data

    Example:
    -----------------------
    &gt;&gt;&gt; data_dict = nxs2txt(&quot;path/to/input.nxs&quot;, &quot;path/to/output.json&quot;)
    &quot;&quot;&quot;
    with h5py.File(file_to_read, &quot;r&quot;) as f:
        # Extract the specific datasets
        energy_loss = f[
            &quot;/processed/summary/1-Combined RIXS image reduction/normalized_correlated_spectrum_0/Energy loss&quot;
        ][:]
        data = f[
            &quot;/processed/summary/1-Combined RIXS image reduction/normalized_correlated_spectrum_0/data&quot;
        ][:]
    # Save it as a JSON file
    data_dict = {&quot;energy&quot;: energy_loss.tolist(), &quot;intensity&quot;: data.tolist()}
    with open(file_to_write, &quot;w&quot;) as f:
        json.dump(data_dict, f, indent=4)

    return {&quot;energy&quot;: energy_loss, &quot;intensity&quot;: data}
</code></pre>

<hr>
<h2 id="extra-uncatagorized-note">extra uncatagorized note</h2>
<p><strong>Open jupyter notebook</strong>: open terminal -&gt; <code>module load python/3.9</code> -&gt; <code>jupyter-notebook</code>, or <code>spyder</code></p>
<p><strong>Open firefox</strong>: open termnial -&gt; <code>firefox -p</code></p>
<p><strong>View meta data</strong>: top right cornor in DAWN -&gt; Dexplorer (data explorer) -&gt; metadata on the right pannel. we probably need to original <code>.nxs</code> file rather than the processed one.</p>
<p><strong>Cabon tape</strong>: the count time of the carbon tape should be the same as the one of the sample and the dark image, otherwise the DAWN software can not process the data (background subtraction and such)</p>
<p><strong>Ice and carbon oxide</strong>: The feature of ice is that it has phonon at around 150-200 meV together with 10+ overtones. The feature of carbon oxide is that it has phonon at ? energy and also multiple overtones. It happens when we are at oxygen edge.</p>
<p><strong>Heating and cooling</strong>: we need to make sure that the temperature of the shiled, the cryostat, the sample are stable, until we can start our measurement. </p>
<hr>
<h4 id="changing-temperature">changing temperature</h4>
<ul>
<li><code>pos tsample 100</code>: heat up sample to 100 K</li>
<li>if we need to heat up, on the control panel -&gt; sample temperature controller -&gt; heater range set to high. If we need to cool down, set it to medium.</li>
<li>GDA panel: plot -&gt; sample temperature -&gt; wait until the temperature of the shield stablized</li>
<li>do a test rixs -&gt; move x to center the rixs signal. If the sample is small, we might also need to move z and y to make sure the beam is on the sample. </li>
</ul>
<p><strong>Beware that</strong>
- below 100K, we can take measurement right after the temperture gets there.
- above 100K, we need to wait extra 1min/K for everything to stablize. For example, we increase the temperature from 100K to 110K, we wait for 10 mins after the sample reaches 110K.</p>
<h2 id="some-unanswered-questions">Some unanswered questions</h2>
<ul>
<li>what's the energy of phonons in carbon oxide</li>
<li>How do we actually differentiate charge transfer and dd excitations. is there pp excitations?</li>
<li>What's the penetration depth? </li>
<li>The oxygen XAS should be smooth with only t2g and Eg peak. Extra structure could come from the hybridzation(?) from other element?</li>
</ul>
<h2 id="changing-temperature_1">changing temperature</h2>
<ul>
<li></li>
</ul>
<hr>
<blockquote>
<p>Te capi? = You got it?
Va a ciapa i Rat = Go away!</p>
</blockquote>
    </div>
</body>



</html>

